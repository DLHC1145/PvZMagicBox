<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>应用数据编辑器</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
		body { background: #f5f5f5; padding: 20px; min-height: 100vh; }
		.container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
		h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; font-size: 1.6rem; }
		
		.upload-section { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; }
		.upload-btn { background: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
		
		.app-list { max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px; }
		.app-item { padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db; display: flex; justify-content: space-between; align-items: center; }
		.app-info h3 { margin-bottom: 5px; font-size: 16px; }
		.app-info p { margin-bottom: 8px; color: #666; }
		.app-actions { display: flex; gap: 10px; flex-shrink: 0; }
		.btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
		.btn-edit { background: #2ecc71; color: white; }
		.btn-delete { background: #e74c3c; color: white; }
		.btn-add { background: #3498db; color: white; padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
		
		.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
		.modal-content { background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 20px; }
		.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
		.modal-header h2 { font-size: 18px; }
		.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
		
		.form-group { margin-bottom: 15px; }
		.form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
		.form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
		.checkbox-group { display: flex; align-items: center; margin-bottom: 10px; }
		.checkbox-group input { margin-right: 8px; }
		
		.download-options { margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; max-height: 200px; overflow-y: auto; }
		.download-option { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
		.download-option input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
		.add-download { background: #95a5a6; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
		
		.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
		.btn-cancel { background: #95a5a6; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
		.btn-save { background: #2ecc71; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
		
		.app-badge { background: #ecf0f1; color: #7f8c8d; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
		
		.export-section { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; }
		.export-section h2 { margin-bottom: 10px; font-size: 16px; }
		.btn-export { background: #9b59b6; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
		
		.code-preview { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; overflow-x: auto; margin-top: 10px; }
		.code-preview code { display: block; }
		
		@media (max-width: 768px) {
			.app-item { flex-direction: column; align-items: flex-start; }
			.app-actions { margin-top: 10px; width: 100%; display: flex; gap: 5px; }
			.app-actions .btn { flex: 1; text-align: center; padding: 8px 0; }
			.download-option { flex-direction: column; gap: 5px; }
			.download-option .btn-delete { width: 100%; }
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>应用数据编辑器</h1>
		
		<div class="upload-section">
			<input type="file" id="fileInput" accept=".html" style="display: none;">
			<button class="upload-btn" id="uploadBtn">上传HTML文件</button>
			<div id="parseStatus">等待上传文件</div>
		</div>
		
		<div class="app-list" id="appList">
			<div style="text-align: center; padding: 40px; color: #7f8c8d;">
				暂无应用数据，请先上传文件或添加新应用
			</div>
		</div>
		
		<button class="btn-add" id="addAppBtn">添加新应用</button>
		
		<div class="export-section">
			<h2>文件导出</h2>
			<button class="btn-export" id="exportFile">导出完整HTML文件</button>
			<div class="code-preview" id="codePreview" style="display: none; margin-top:10px;">
				<code id="codeContent"></code>
			</div>
		</div>
	</div>
	
	<div class="modal" id="appModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="modalTitle">编辑应用</h2>
				<button class="close-btn" id="closeModal">&times;</button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label for="appName">应用名称</label>
					<input type="text" id="appName" class="form-control" placeholder="必填">
				</div>
				<div class="form-group">
					<label for="appScore">评分描述</label>
					<input type="text" id="appScore" class="form-control" placeholder="例：9.2分 安全稳定">
				</div>
				<div class="form-group">
					<label for="appImage">图片路径</label>
					<input type="text" id="appImage" class="form-control" placeholder="本地路径或网络链接">
				</div>
				<div class="form-group">
					<label for="appDownloadUrl">下载链接</label>
					<input type="text" id="appDownloadUrl" class="form-control" placeholder="主下载链接">
				</div>
				<div class="form-group">
					<label for="appDownloadText">下载按钮文本</label>
					<input type="text" id="appDownloadText" class="form-control" placeholder="例：立即下载/获取">
				</div>
				
				<div class="checkbox-group">
					<input type="checkbox" id="isSpecial">
					<label for="isSpecial">特殊样式</label>
				</div>
				<div class="checkbox-group">
					<input type="checkbox" id="forceFirst">
					<label for="forceFirst">优先显示（置顶）</label>
				</div>
				<div class="checkbox-group">
					<input type="checkbox" id="SplashScreen">
					<label for="SplashScreen">进入前显示弹窗</label>
				</div>
				
				<div class="form-group" id="splashUrlGroup" style="display: none;">
					<label for="splashUrl">弹窗链接</label>
					<input type="text" id="splashUrl" class="form-control" placeholder="弹窗跳转链接">
				</div>
				
				<div class="form-group">
					<label>弹窗内容（留空则无弹窗配置）</label>
					<textarea id="popupText" class="form-control" rows="3" placeholder="弹窗显示的文本内容"></textarea>
				</div>
				
				<div class="download-options">
					<label>下载选项（至少填1组才会生成）</label>
					<div id="downloadOptions"></div>
					<button class="add-download" id="addDownload">添加下载选项</button>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn-cancel" id="cancelEdit">取消</button>
				<button class="btn-save" id="saveApp">保存</button>
			</div>
		</div>
	</div>

	<script>
		let apps = [];
		let currentEditingIndex = -1;
		let originalHtmlContent = ''; // 保存上传文件的完整内容
		
		const uploadBtn = document.getElementById('uploadBtn');
		const fileInput = document.getElementById('fileInput');
		const parseStatus = document.getElementById('parseStatus');
		const appList = document.getElementById('appList');
		const addAppBtn = document.getElementById('addAppBtn');
		const appModal = document.getElementById('appModal');
		const modalTitle = document.getElementById('modalTitle');
		const closeModal = document.getElementById('closeModal');
		const cancelEdit = document.getElementById('cancelEdit');
		const saveApp = document.getElementById('saveApp');
		const SplashScreen = document.getElementById('SplashScreen');
		const splashUrlGroup = document.getElementById('splashUrlGroup');
		const addDownload = document.getElementById('addDownload');
		const downloadOptions = document.getElementById('downloadOptions');
		const exportFile = document.getElementById('exportFile');
		const codePreview = document.getElementById('codePreview');
		const codeContent = document.getElementById('codeContent');
		
		const appName = document.getElementById('appName');
		const appScore = document.getElementById('appScore');
		const appImage = document.getElementById('appImage');
		const appDownloadUrl = document.getElementById('appDownloadUrl');
		const appDownloadText = document.getElementById('appDownloadText');
		const isSpecial = document.getElementById('isSpecial');
		const forceFirst = document.getElementById('forceFirst');
		const splashUrl = document.getElementById('splashUrl');
		const popupText = document.getElementById('popupText');
		
		// 事件绑定
		uploadBtn.addEventListener('click', () => fileInput.click());
		fileInput.addEventListener('change', handleFileUpload);
		addAppBtn.addEventListener('click', () => {
			currentEditingIndex = -1;
			modalTitle.textContent = '添加新应用';
			resetForm();
			appModal.style.display = 'flex';
		});
		closeModal.addEventListener('click', () => appModal.style.display = 'none');
		cancelEdit.addEventListener('click', () => appModal.style.display = 'none');
		saveApp.addEventListener('click', saveAppData);
		SplashScreen.addEventListener('change', () => {
			splashUrlGroup.style.display = SplashScreen.checked ? 'block' : 'none';
		});
		addDownload.addEventListener('click', () => addDownloadOption());
		exportFile.addEventListener('click', exportCompleteHtml);
		
		// 上传解析（保存完整HTML+提取应用数据）
		function handleFileUpload() {
			if (!fileInput.files.length) return;
			const file = fileInput.files[0];
			if (file.type !== 'text/html') {
				parseStatus.innerHTML = '<span style="color: #e74c3c;">错误：请上传HTML文件</span>';
				return;
			}
			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					// 保存上传文件的完整内容（关键！导出时复用）
					originalHtmlContent = e.target.result;
					const parser = new DOMParser();
					const doc = parser.parseFromString(originalHtmlContent, 'text/html');
					const scriptContent = doc.querySelector('script').textContent;
					const match = scriptContent.match(/const originalSoftwareData = (\[.*?\]);/s);
					
					if (match) {
						const dataArray = new Function('return ' + match[1])();
						apps = dataArray;
						parseStatus.innerHTML = `<span style="color: #2ecc71;">成功：解析到 ${apps.length} 个应用</span>`;
					} else {
						// 无数据则初始化示例，保留完整HTML
						apps = [{
							name: "示例应用",
							score: "8.5分 示例描述",
							image: "example.jpg",
							downloadUrl: "https://example.com",
							downloadText: "下载",
							isSpecial: false,
							forceFirst: false,
							SplashScreen: false
						}];
						parseStatus.innerHTML = `<span style="color: #f39c12;">警告：未找到应用数据，加载示例应用</span>`;
					}
					renderAppList();
				} catch (error) {
					parseStatus.innerHTML = `<span style="color: #e74c3c;">错误：解析失败 - ${error.message}</span>`;
				}
			};
			reader.readAsText(file);
		}
		
		// 渲染应用列表
		function renderAppList() {
			if (!apps.length) {
				appList.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">暂无应用数据</div>';
				return;
			}
			const sortedApps = [...apps].sort((a, b) => a.forceFirst && !b.forceFirst ? -1 : (!a.forceFirst && b.forceFirst ? 1 : 0));
			appList.innerHTML = sortedApps.map((app, index) => {
				const originalIndex = apps.findIndex(a => a === app);
				const hasPopup = app.popup ? '<span class="app-badge">有弹窗</span>' : '';
				return `<div class="app-item"><div class="app-info"><h3>${app.name} ${app.forceFirst ? '<span class="app-badge">置顶</span>' : ''} ${app.isSpecial ? '<span class="app-badge">特殊</span>' : ''}</h3><p>${app.score}</p><div>${app.SplashScreen ? '<span class="app-badge">启动弹窗</span>' : ''} ${hasPopup}</div></div><div class="app-actions"><button class="btn btn-edit" onclick="editApp(${originalIndex})">编辑</button><button class="btn btn-delete" onclick="deleteApp(${originalIndex})">删除</button></div></div>`;
			}).join('');
		}
		
		// 编辑应用
		window.editApp = function(index) {
			currentEditingIndex = index;
			modalTitle.textContent = '编辑应用';
			const app = apps[index];
			appName.value = app.name || '';
			appScore.value = app.score || '';
			appImage.value = app.image || '';
			appDownloadUrl.value = app.downloadUrl || '';
			appDownloadText.value = app.downloadText || '';
			isSpecial.checked = app.isSpecial || false;
			forceFirst.checked = app.forceFirst || false;
			SplashScreen.checked = app.SplashScreen || false;
			splashUrl.value = app.splashUrl || '';
			popupText.value = app.popup?.text || '';
			splashUrlGroup.style.display = SplashScreen.checked ? 'block' : 'none';
			downloadOptions.innerHTML = '';
			app.popup?.downloads?.forEach((item, i) => addDownloadOption(item.url, item.text, i));
			appModal.style.display = 'flex';
		};
		
		// 删除应用
		window.deleteApp = function(index) {
			if (confirm('确定删除该应用？')) {
				apps.splice(index, 1);
				renderAppList();
				showToast('应用已删除');
			}
		};
		
		// 保存应用（无弹窗不生成popup字段）
		function saveAppData() {
			if (!appName.value.trim()) {
				alert('请输入应用名称！');
				return;
			}
			const downloads = [];
			document.querySelectorAll('.download-option').forEach(option => {
				const url = option.querySelector('input:first-child').value.trim();
				const text = option.querySelector('input:last-child').value.trim();
				url && text && downloads.push({url, text});
			});
			const appData = {
				name: appName.value.trim(),
				score: appScore.value.trim(),
				image: appImage.value.trim(),
				downloadUrl: appDownloadUrl.value.trim(),
				downloadText: appDownloadText.value.trim(),
				isSpecial: isSpecial.checked,
				forceFirst: forceFirst.checked,
				SplashScreen: SplashScreen.checked
			};
			if (SplashScreen.checked && splashUrl.value.trim()) appData.splashUrl = splashUrl.value.trim();
			const popupTextVal = popupText.value.trim();
			if (popupTextVal || downloads.length > 0) {
				appData.popup = { text: popupTextVal, downloads: downloads };
			}
			currentEditingIndex === -1 ? apps.push(appData) : apps[currentEditingIndex] = appData;
			showToast(currentEditingIndex === -1 ? '应用已添加' : '应用已更新');
			renderAppList();
			appModal.style.display = 'none';
		}
		
		// 添加下载选项
		function addDownloadOption(url = '', text = '') {
			const optionDiv = document.createElement('div');
			optionDiv.className = 'download-option';
			optionDiv.innerHTML = `<input type="text" placeholder="下载链接" value="${url}"><input type="text" placeholder="按钮文本" value="${text}"><button class="btn-delete" onclick="this.parentElement.remove()">删除</button>`;
			downloadOptions.appendChild(optionDiv);
		}
		
		// 重置表单
		function resetForm() {
			appName.value = ''; appScore.value = ''; appImage.value = '';
			appDownloadUrl.value = ''; appDownloadText.value = '';
			isSpecial.checked = forceFirst.checked = SplashScreen.checked = false;
			splashUrl.value = ''; popupText.value = '';
			downloadOptions.innerHTML = '';
			splashUrlGroup.style.display = 'none';
		}
		
		// 提示框
		function showToast(message) {
			const toast = document.createElement('div');
			toast.textContent = message;
			toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#2ecc71;color:white;padding:15px 25px;border-radius:6px;z-index:1001;';
			document.body.appendChild(toast);
			setTimeout(() => toast.remove(), 3000);
		}
		
		// 核心：导出完整HTML（替换应用数据，保留原文件所有内容）
		function exportCompleteHtml() {
			if (!apps.length) {
				alert('暂无应用数据，无法导出！');
				return;
			}
			if (!originalHtmlContent) {
				alert('请先上传HTML文件！');
				return;
			}
			
			// 生成新的应用数据代码
			const newDataCode = `const originalSoftwareData = ${JSON.stringify(apps, null, 2)};`;
			// 替换原文件中的应用数据，其他内容完全保留
			const newHtmlContent = originalHtmlContent.replace(/const originalSoftwareData = (\[.*?\]);/s, newDataCode);
			
			// 创建下载文件
			const blob = new Blob([newHtmlContent], { type: 'text/html' });
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = '应用数据_编辑后.html';
			a.click();
			URL.revokeObjectURL(a.href);
			showToast('完整HTML文件已导出！');
		}
	</script>
</body>
</html>