<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>应用数据编辑器</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
		body { background: #f5f5f5; padding: 20px; min-height: 100vh; }
		.container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
		h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
		
		.upload-section { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; }
		.upload-btn { background: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
		
		.app-list { max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px; }
		.app-item { padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db; display: flex; justify-content: space-between; align-items: center; }
		.app-info h3 { margin-bottom: 5px; font-size: 16px; }
		.app-info p { margin-bottom: 8px; color: #666; }
		.app-actions { display: flex; gap: 10px; flex-shrink: 0; }
		.btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
		.btn-edit { background: #2ecc71; color: white; }
		.btn-delete { background: #e74c3c; color: white; }
		.btn-add { background: #3498db; color: white; padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
		
		.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
		.modal-content { background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 20px; }
		.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
		.modal-header h2 { font-size: 18px; }
		.close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
		
		.form-group { margin-bottom: 15px; }
		.form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
		.form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
		.checkbox-group { display: flex; align-items: center; margin-bottom: 10px; }
		.checkbox-group input { margin-right: 8px; }
		
		.download-options { margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; max-height: 200px; overflow-y: auto; }
		.download-option { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
		.download-option input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
		.add-download { background: #95a5a6; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
		
		.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
		.btn-cancel { background: #95a5a6; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
		.btn-save { background: #2ecc71; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
		
		.app-badge { background: #ecf0f1; color: #7f8c8d; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
		
		/* 响应式调整 */
		@media (max-width: 768px) {
			.app-item { flex-direction: column; align-items: flex-start; }
			.app-actions { margin-top: 10px; width: 100%; }
			.app-actions .btn { flex: 1; }
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>应用数据编辑器</h1>
		
		<div class="upload-section">
			<input type="file" id="fileInput" accept=".html" style="display: none;">
			<button class="upload-btn" id="uploadBtn">上传HTML文件</button>
			<div id="parseStatus">等待上传文件</div>
		</div>
		
		<div class="app-list" id="appList">
			<div style="text-align: center; padding: 40px; color: #7f8c8d;">
				暂无应用数据，请先上传HTML文件
			</div>
		</div>
		
		<button class="btn-add" id="addAppBtn">添加新应用</button>
	</div>
	
	<!-- 应用编辑模态框 -->
	<div class="modal" id="appModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="modalTitle">编辑应用</h2>
				<button class="close-btn" id="closeModal">&times;</button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label for="appName">应用名称</label>
					<input type="text" id="appName" class="form-control">
				</div>
				
				<div class="form-group">
					<label for="appScore">评分描述</label>
					<input type="text" id="appScore" class="form-control">
				</div>
				
				<div class="form-group">
					<label for="appImage">图片路径</label>
					<input type="text" id="appImage" class="form-control">
				</div>
				
				<div class="form-group">
					<label for="appDownloadUrl">下载链接</label>
					<input type="text" id="appDownloadUrl" class="form-control">
				</div>
				
				<div class="form-group">
					<label for="appDownloadText">下载按钮文本</label>
					<input type="text" id="appDownloadText" class="form-control">
				</div>
				
				<div class="checkbox-group">
					<input type="checkbox" id="isSpecial">
					<label for="isSpecial">特殊样式</label>
				</div>
				
				<div class="checkbox-group">
					<input type="checkbox" id="forceFirst">
					<label for="forceFirst">优先显示</label>
				</div>
				
				<div class="checkbox-group">
					<input type="checkbox" id="SplashScreen">
					<label for="SplashScreen">进入前显示弹窗</label>
				</div>
				
				<div class="form-group" id="splashUrlGroup" style="display: none;">
					<label for="splashUrl">弹窗链接</label>
					<input type="text" id="splashUrl" class="form-control">
				</div>
				
				<div class="form-group">
					<label>弹窗内容</label>
					<textarea id="popupText" class="form-control" rows="3"></textarea>
				</div>
				
				<div class="download-options">
					<label>下载选项</label>
					<div id="downloadOptions"></div>
					<button class="add-download" id="addDownload">添加下载选项</button>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn-cancel" id="cancelEdit">取消</button>
				<button class="btn-save" id="saveApp">保存</button>
			</div>
		</div>
	</div>

	<script>
		// 应用数据
		let apps = [];
		let currentEditingIndex = -1;
		
		// DOM元素
		const uploadBtn = document.getElementById('uploadBtn');
		const fileInput = document.getElementById('fileInput');
		const parseStatus = document.getElementById('parseStatus');
		const appList = document.getElementById('appList');
		const addAppBtn = document.getElementById('addAppBtn');
		const appModal = document.getElementById('appModal');
		const modalTitle = document.getElementById('modalTitle');
		const closeModal = document.getElementById('closeModal');
		const cancelEdit = document.getElementById('cancelEdit');
		const saveApp = document.getElementById('saveApp');
		const SplashScreen = document.getElementById('SplashScreen');
		const splashUrlGroup = document.getElementById('splashUrlGroup');
		const addDownload = document.getElementById('addDownload');
		const downloadOptions = document.getElementById('downloadOptions');
		
		// 表单元素
		const appName = document.getElementById('appName');
		const appScore = document.getElementById('appScore');
		const appImage = document.getElementById('appImage');
		const appDownloadUrl = document.getElementById('appDownloadUrl');
		const appDownloadText = document.getElementById('appDownloadText');
		const isSpecial = document.getElementById('isSpecial');
		const forceFirst = document.getElementById('forceFirst');
		const splashUrl = document.getElementById('splashUrl');
		const popupText = document.getElementById('popupText');
		
		// 事件监听
		uploadBtn.addEventListener('click', () => fileInput.click());
		fileInput.addEventListener('change', handleFileUpload);
		addAppBtn.addEventListener('click', () => {
			currentEditingIndex = -1;
			modalTitle.textContent = '添加新应用';
			resetForm();
			appModal.style.display = 'flex';
		});
		closeModal.addEventListener('click', () => appModal.style.display = 'none');
		cancelEdit.addEventListener('click', () => appModal.style.display = 'none');
		saveApp.addEventListener('click', saveAppData);
		SplashScreen.addEventListener('change', () => {
			splashUrlGroup.style.display = SplashScreen.checked ? 'block' : 'none';
		});
		addDownload.addEventListener('click', addDownloadOption);
		
		// 处理文件上传
		function handleFileUpload() {
			if (fileInput.files.length === 0) return;
			
			const file = fileInput.files[0];
			
			if (file.type !== 'text/html') {
				parseStatus.innerHTML = '<span style="color: #e74c3c;">错误：请上传HTML文件</span>';
				return;
			}
			
			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					// 解析HTML文件中的app数据
					const parser = new DOMParser();
					const doc = parser.parseFromString(e.target.result, 'text/html');
					
					// 查找originalSoftwareData数组
					const scriptContent = doc.querySelector('script').textContent;
					const match = scriptContent.match(/const originalSoftwareData = (\[.*?\]);/s);
					
					if (match) {
						// 使用Function构造函数安全地解析数组
						const dataArray = new Function('return ' + match[1])();
						apps = dataArray;
						parseStatus.innerHTML = `<span style="color: #2ecc71;">成功：解析到 ${apps.length} 个应用</span>`;
					} else {
						// 如果没有找到数据，使用示例数据
						apps = [
							{
								name: "示例应用1",
								score: "8.5分 示例描述",
								image: "example1.jpg",
								downloadUrl: "https://example.com/app1",
								downloadText: "下载",
								isSpecial: false,
								forceFirst: false,
								SplashScreen: false,
								popup: {
									text: "示例弹窗内容",
									downloads: [
										{ url: "https://example.com/download1", text: "下载选项1" },
										{ url: "https://example.com/download2", text: "下载选项2" }
									]
								}
							}
						];
						parseStatus.innerHTML = `<span style="color: #f39c12;">警告：未找到应用数据，已加载示例数据</span>`;
					}
					
					renderAppList();
				} catch (error) {
					parseStatus.innerHTML = `<span style="color: #e74c3c;">错误：解析文件失败 - ${error.message}</span>`;
				}
			};
			
			reader.onerror = function() {
				parseStatus.innerHTML = '<span style="color: #e74c3c;">错误：读取文件失败</span>';
			};
			
			reader.readAsText(file);
		}
		
		// 渲染应用列表
		function renderAppList() {
			if (apps.length === 0) {
				appList.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">暂无应用数据</div>';
				return;
			}
			
			// 将置顶的应用排在前面
			const sortedApps = [...apps].sort((a, b) => {
				if (a.forceFirst && !b.forceFirst) return -1;
				if (!a.forceFirst && b.forceFirst) return 1;
				return 0;
			});
			
			appList.innerHTML = sortedApps.map((app, index) => {
				const originalIndex = apps.findIndex(a => a === app);
				return `
					<div class="app-item">
						<div class="app-info">
							<h3>${app.name} ${app.forceFirst ? '<span class="app-badge">置顶</span>' : ''} ${app.isSpecial ? '<span class="app-badge">特殊</span>' : ''}</h3>
							<p>${app.score}</p>
							<div>
								${app.SplashScreen ? '<span class="app-badge">有弹窗</span>' : ''}
								${app.popup ? '<span class="app-badge">有详情</span>' : ''}
							</div>
						</div>
						<div class="app-actions">
							<button class="btn btn-edit" onclick="editApp(${originalIndex})">编辑</button>
							<button class="btn btn-delete" onclick="deleteApp(${originalIndex})">删除</button>
						</div>
					</div>
				`;
			}).join('');
		}
		
		// 编辑应用
		window.editApp = function(index) {
			currentEditingIndex = index;
			modalTitle.textContent = '编辑应用';
			
			const app = apps[index];
			appName.value = app.name || '';
			appScore.value = app.score || '';
			appImage.value = app.image || '';
			appDownloadUrl.value = app.downloadUrl || '';
			appDownloadText.value = app.downloadText || '';
			isSpecial.checked = app.isSpecial || false;
			forceFirst.checked = app.forceFirst || false;
			SplashScreen.checked = app.SplashScreen || false;
			splashUrl.value = app.splashUrl || '';
			popupText.value = app.popup ? app.popup.text : '';
			
			// 显示/隐藏弹窗链接输入框
			splashUrlGroup.style.display = SplashScreen.checked ? 'block' : 'none';
			
			// 渲染下载选项
			downloadOptions.innerHTML = '';
			if (app.popup && app.popup.downloads) {
				app.popup.downloads.forEach((download, i) => {
					addDownloadOption(download.url, download.text, i);
				});
			}
			
			appModal.style.display = 'flex';
		};
		
		// 删除应用
		window.deleteApp = function(index) {
			if (confirm('确定要删除这个应用吗？')) {
				apps.splice(index, 1);
				renderAppList();
				showToast('应用已删除');
			}
		};
		
		// 保存应用数据
		function saveAppData() {
			if (!appName.value.trim()) {
				alert('请输入应用名称');
				return;
			}
			
			// 收集下载选项
			const downloads = [];
			document.querySelectorAll('.download-option').forEach(option => {
				const url = option.querySelector('input[type="text"]').value;
				const text = option.querySelector('input[type="text"]:nth-child(2)').value;
				if (url.trim() && text.trim()) {
					downloads.push({ url: url.trim(), text: text.trim() });
				}
			});
			
			const appData = {
				name: appName.value.trim(),
				score: appScore.value.trim(),
				image: appImage.value.trim(),
				downloadUrl: appDownloadUrl.value.trim(),
				downloadText: appDownloadText.value.trim(),
				isSpecial: isSpecial.checked,
				forceFirst: forceFirst.checked,
				SplashScreen: SplashScreen.checked,
				splashUrl: splashUrl.value.trim(),
				popup: {
					text: popupText.value.trim(),
					downloads: downloads
				}
			};
			
			if (currentEditingIndex === -1) {
				// 新增应用
				apps.push(appData);
				showToast('应用已添加');
			} else {
				// 编辑现有应用
				apps[currentEditingIndex] = appData;
				showToast('应用已更新');
			}
			
			renderAppList();
			appModal.style.display = 'none';
		}
		
		// 添加下载选项
		function addDownloadOption(url = '', text = '', index = null) {
			const optionDiv = document.createElement('div');
			optionDiv.className = 'download-option';
			optionDiv.innerHTML = `
				<input type="text" placeholder="下载链接" value="${url}">
				<input type="text" placeholder="按钮文本" value="${text}">
				<button class="btn-delete" onclick="this.parentElement.remove()">删除</button>
			`;
			downloadOptions.appendChild(optionDiv);
		}
		
		// 重置表单
		function resetForm() {
			appName.value = '';
			appScore.value = '';
			appImage.value = '';
			appDownloadUrl.value = '';
			appDownloadText.value = '';
			isSpecial.checked = false;
			forceFirst.checked = false;
			SplashScreen.checked = false;
			splashUrl.value = '';
			popupText.value = '';
			downloadOptions.innerHTML = '';
			splashUrlGroup.style.display = 'none';
		}
		
		// 显示提示消息
		function showToast(message) {
			const toast = document.createElement('div');
			toast.textContent = message;
			toast.style.cssText = `
				position: fixed;
				bottom: 20px;
				right: 20px;
				background: #2ecc71;
				color: white;
				padding: 15px 25px;
				border-radius: 6px;
				z-index: 1001;
			`;
			document.body.appendChild(toast);
			
			setTimeout(() => {
				toast.remove();
			}, 3000);
		}
	</script>
</body>
</html>