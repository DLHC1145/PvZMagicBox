<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PVZ2 å­˜æ¡£ç¼–è¾‘å™¨</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Segoe UI', system-ui, sans-serif;
		}
		
		body {
			background: #f8f9fa;
			color: #333;
			min-height: 100vh;
			padding: 10px;
		}
		
		.container {
			max-width: 500px;
			margin: 0 auto;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			overflow: hidden;
		}
		
		header {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: white;
			padding: 20px;
			text-align: center;
		}
		
		h1 {
			font-size: 1.5rem;
			margin-bottom: 5px;
		}
		
		.content {
			padding: 20px;
		}
		
		.file-upload-area {
			background: #f8f9fa;
			border: 2px dashed #4a6491;
			border-radius: 6px;
			padding: 30px 15px;
			text-align: center;
			cursor: pointer;
			margin-bottom: 15px;
		}
		
		.file-upload-area:hover {
			background: #f0f7ff;
		}
		
		#datFile {
			display: none;
		}
		
		#fileName {
			font-weight: 600;
			color: #2ecc71;
			margin: 10px 0;
		}
		
		.editor-section {
			display: none;
		}
		
		.editor-item {
			background: #f8f9fa;
			border-radius: 6px;
			padding: 15px;
			margin-bottom: 10px;
		}
		
		.editor-item h3 {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 10px;
			font-size: 0.9rem;
		}
		
		.icon {
			width: 25px;
			height: 25px;
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			border-radius: 50%;
			text-align: center;
			line-height: 25px;
			color: white;
		}
		
		.diamond-icon {
			background: linear-gradient(135deg, #3498db, #2980b9);
		}
		
		.current-value {
			font-size: 1.2rem;
			font-weight: bold;
			color: #2ecc71;
			text-align: center;
			margin: 5px 0;
		}
		
		.original-value {
			font-size: 0.8rem;
			color: #666;
			text-align: center;
		}
		
		.value-input {
			width: 100%;
			padding: 8px;
			border: 2px solid #ddd;
			border-radius: 6px;
			text-align: center;
			font-weight: bold;
		}
		
		button {
			width: 100%;
			padding: 12px;
			border: none;
			border-radius: 6px;
			font-weight: 600;
			cursor: pointer;
			margin-top: 10px;
		}
		
		.btn-primary {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: white;
		}
		
		.btn-secondary {
			background: #e0e0e0;
			color: #666;
		}
		
		.error {
			background: #ffeaea;
			color: #c0392b;
			padding: 10px;
			border-radius: 6px;
			margin-top: 10px;
			display: none;
		}
		
		.success {
			background: #e8f5e8;
			color: #27ae60;
			padding: 10px;
			border-radius: 6px;
			margin-top: 10px;
			display: none;
		}
		
		.loading {
			text-align: center;
			padding: 10px;
			color: #4a6491;
			display: none;
		}
		
		footer {
			text-align: center;
			padding: 15px;
			color: #666;
			font-size: 0.8rem;
		}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>ğŸŒ± PVZ2 å­˜æ¡£ç¼–è¾‘å™¨</h1>
			<p>ä¿®æ”¹é‡‘å¸(c)å’Œé’»çŸ³(g)æ•°é‡</p>
		</header>
		
		<div class="content">
			<div class="file-upload-area" onclick="document.getElementById('datFile').click()">
				ğŸ“
				<p>ç‚¹å‡»é€‰æ‹©PP.datæ–‡ä»¶</p>
				<p id="fileName">æœªé€‰æ‹©æ–‡ä»¶</p>
			</div>
			<input type="file" id="datFile" accept=".dat">
			
			<div class="loading" id="loadingArea">å¤„ç†ä¸­...</div>
			
			<div id="fileError" class="error"></div>
			<div id="fileSuccess" class="success"></div>
			
			<div class="editor-section" id="editorSection">
				<div class="editor-item">
					<h3><span class="icon">ğŸ’°</span>é‡‘å¸ (c)</h3>
					<div class="original-value" id="originalCoins">åŸå§‹: 0</div>
					<div class="current-value" id="currentCoins">0</div>
					<input type="number" class="value-input" id="coinsInput" value="0" min="0" max="999999999">
				</div>
				
				<div class="editor-item">
					<h3><span class="icon diamond-icon">ğŸ’</span>é’»çŸ³ (g)</h3>
					<div class="original-value" id="originalGems">åŸå§‹: 0</div>
					<div class="current-value" id="currentGems">0</div>
					<input type="number" class="value-input" id="gemsInput" value="0" min="0" max="999999">
				</div>
				
				<button class="btn-primary" onclick="saveChanges()">ğŸ’¾ ä¿å­˜ä¸º PP.dat</button>
				<button class="btn-secondary" onclick="resetEditor()">ğŸ”„ é‡ç½®</button>
				
				<div id="editorError" class="error"></div>
				<div id="editorSuccess" class="success"></div>
			</div>
		</div>
		
		<footer>
			æ•°æ®åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†
		</footer>
	</div>

	<script src="json2rton.js"></script>
	<script src="rton2json.js"></script>
	
	<script>
		let originalJson = '';
		let originalJsonData = null;
		let originalHexData = '';
		
		// é€‰æ‹©æ–‡ä»¶
		document.getElementById('datFile').addEventListener('change', async function(e) {
			const file = e.target.files[0];
			if (!file) return;
			
			document.getElementById('fileName').textContent = file.name;
			showLoading();
			
			try {
				const buffer = await readFileAsArrayBuffer(file);
				originalHexData = arrayBufferToHexString(buffer);
				
				// è½¬æ¢RTONä¸ºJSON
				const rton2json = new RTON2JSON();
				rton2json.set(new Uint8Array(buffer));
				originalJson = rton2json.get();
				originalJsonData = JSON.parse(originalJson);
				
				// æŸ¥æ‰¾cå’Œgçš„å€¼
				const coins = findValue(originalJson, '"c"');
				const gems = findValue(originalJson, '"g"');
				
				// æ˜¾ç¤ºå€¼
				document.getElementById('originalCoins').textContent = 'åŸå§‹: ' + coins;
				document.getElementById('currentCoins').textContent = coins;
				document.getElementById('coinsInput').value = coins;
				
				document.getElementById('originalGems').textContent = 'åŸå§‹: ' + gems;
				document.getElementById('currentGems').textContent = gems;
				document.getElementById('gemsInput').value = gems;
				
				// æ˜¾ç¤ºç¼–è¾‘å™¨
				document.getElementById('editorSection').style.display = 'block';
				showSuccess('fileSuccess', 'æ–‡ä»¶åŠ è½½æˆåŠŸ');
				
			} catch (error) {
				showError('fileError', 'åŠ è½½å¤±è´¥: ' + error.message);
			} finally {
				hideLoading();
			}
		});
		
		// æŸ¥æ‰¾JSONå­—ç¬¦ä¸²ä¸­çš„å€¼
		function findValue(jsonStr, key) {
			const index = jsonStr.indexOf(key);
			if (index === -1) return 0;
			
			// æŸ¥æ‰¾å†’å·åçš„æ•°å­—
			let start = index + key.length;
			while (start < jsonStr.length && jsonStr[start] !== ':') start++;
			start++; // è·³è¿‡å†’å·
			
			// è·³è¿‡ç©ºæ ¼
			while (start < jsonStr.length && jsonStr[start] <= ' ') start++;
			
			// æå–æ•°å­—
			let end = start;
			while (end < jsonStr.length && jsonStr[end] >= '0' && jsonStr[end] <= '9') end++;
			
			const numStr = jsonStr.substring(start, end);
			return parseInt(numStr) || 0;
		}
		
		// æ›¿æ¢JSONå­—ç¬¦ä¸²ä¸­çš„å€¼
		function replaceValue(jsonStr, key, newValue) {
			const index = jsonStr.indexOf(key);
			if (index === -1) return jsonStr;
			
			// æŸ¥æ‰¾å†’å·ä½ç½®
			let colonIndex = index + key.length;
			while (colonIndex < jsonStr.length && jsonStr[colonIndex] !== ':') colonIndex++;
			
			// æŸ¥æ‰¾æ•°å­—å¼€å§‹ä½ç½®
			let numStart = colonIndex + 1;
			while (numStart < jsonStr.length && jsonStr[numStart] <= ' ') numStart++;
			
			// æŸ¥æ‰¾æ•°å­—ç»“æŸä½ç½®
			let numEnd = numStart;
			while (numEnd < jsonStr.length && jsonStr[numEnd] >= '0' && jsonStr[numEnd] <= '9') numEnd++;
			
			// æ›¿æ¢æ•°å­—
			const before = jsonStr.substring(0, numStart);
			const after = jsonStr.substring(numEnd);
			return before + newValue + after;
		}
		
		// ä¿å­˜ä¿®æ”¹
		function saveChanges() {
			if (!originalJson) {
				showError('editorError', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
				return;
			}
			
			showLoading();
			
			try {
				const newCoins = document.getElementById('coinsInput').value;
				const newGems = document.getElementById('gemsInput').value;
				
				// åˆ›å»ºä¿®æ”¹åçš„JSON
				let modifiedJson = originalJson;
				
				// åªæ›¿æ¢cå’Œgçš„æ•°å­—
				modifiedJson = replaceValue(modifiedJson, '"c"', newCoins);
				modifiedJson = replaceValue(modifiedJson, '"g"', newGems);
				
				// éªŒè¯JSON
				try {
					JSON.parse(modifiedJson);
				} catch (e) {
					throw new Error('ä¿®æ”¹åçš„JSONæ ¼å¼é”™è¯¯');
				}
				
				// è½¬æ¢å›RTON
				const json2rton = new JSON2RTON();
				json2rton.set(modifiedJson);
				
				// å°è¯•è·å–äºŒè¿›åˆ¶æ•°æ®
				let rtonData;
				try {
					rtonData = json2rton.get("binary");
				} catch (e) {
					// å¦‚æœbinaryå¤±è´¥ï¼Œå°è¯•hex
					const hexData = json2rton.get("hex").replace(/\s/g, '');
					rtonData = hexToArrayBuffer(hexData);
				}
				
				// ä¸‹è½½æ–‡ä»¶
				downloadFile(rtonData, 'PP.dat', 'application/octet-stream');
				
				// æ›´æ–°æ˜¾ç¤º
				document.getElementById('currentCoins').textContent = newCoins;
				document.getElementById('currentGems').textContent = newGems;
				document.getElementById('originalCoins').textContent = 'åŸå§‹: ' + newCoins;
				document.getElementById('originalGems').textContent = 'åŸå§‹: ' + newGems;
				
				// æ›´æ–°åŸå§‹æ•°æ®
				originalJson = modifiedJson;
				originalJsonData = JSON.parse(modifiedJson);
				
				showSuccess('editorSuccess', 'ä¿å­˜æˆåŠŸï¼å·²ä¸‹è½½PP.dat');
				
			} catch (error) {
				showError('editorError', 'ä¿å­˜å¤±è´¥: ' + error.message);
			} finally {
				hideLoading();
			}
		}
		
		// é‡ç½®ä¿®æ”¹
		function resetEditor() {
			if (originalJsonData) {
				const coins = findValue(originalJson, '"c"');
				const gems = findValue(originalJson, '"g"');
				
				document.getElementById('coinsInput').value = coins;
				document.getElementById('gemsInput').value = gems;
				document.getElementById('currentCoins').textContent = coins;
				document.getElementById('currentGems').textContent = gems;
				
				showSuccess('editorSuccess', 'å·²é‡ç½®');
			}
		}
		
		// å·¥å…·å‡½æ•°
		function readFileAsArrayBuffer(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result);
				reader.onerror = reject;
				reader.readAsArrayBuffer(file);
			});
		}
		
		function arrayBufferToHexString(buffer) {
			const bytes = new Uint8Array(buffer);
			let hex = '';
			for (let i = 0; i < bytes.length; i++) {
				const byte = bytes[i].toString(16).padStart(2, '0');
				hex += byte;
			}
			return hex;
		}
		
		function hexToArrayBuffer(hex) {
			hex = hex.replace(/\s/g, '');
			const bytes = new Uint8Array(hex.length / 2);
			for (let i = 0; i < hex.length; i += 2) {
				bytes[i/2] = parseInt(hex.substr(i, 2), 16);
			}
			return bytes;
		}
		
		function downloadFile(data, filename, type) {
			const blob = new Blob([data], {type});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}
		
		function showError(id, msg) {
			const el = document.getElementById(id);
			el.textContent = msg;
			el.style.display = 'block';
			setTimeout(() => el.style.display = 'none', 3000);
		}
		
		function showSuccess(id, msg) {
			const el = document.getElementById(id);
			el.textContent = msg;
			el.style.display = 'block';
			setTimeout(() => el.style.display = 'none', 3000);
		}
		
		function showLoading() {
			document.getElementById('loadingArea').style.display = 'block';
		}
		
		function hideLoading() {
			document.getElementById('loadingArea').style.display = 'none';
		}
	</script>
</body>
</html>