<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PVZ2 å­˜æ¡£ç¼–è¾‘å™¨</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Segoe UI', system-ui, sans-serif;
		}
		
		body {
			background: #f8f9fa;
			color: #333;
			min-height: 100vh;
			padding: 10px;
		}
		
		.container {
			max-width: 500px;
			margin: 0 auto;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			overflow: hidden;
		}
		
		header {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: white;
			padding: 20px;
			text-align: center;
		}
		
		h1 {
			font-size: 1.5rem;
			margin-bottom: 5px;
		}
		
		.subtitle {
			font-size: 0.85rem;
			opacity: 0.9;
		}
		
		.content {
			padding: 20px;
		}
		
		.file-upload-area {
			background: #f8f9fa;
			border: 2px dashed #4a6491;
			border-radius: 6px;
			padding: 30px 15px;
			text-align: center;
			cursor: pointer;
			margin-bottom: 15px;
		}
		
		.file-upload-area:hover {
			background: #f0f7ff;
		}
		
		#datFile {
			display: none;
		}
		
		#fileName {
			font-weight: 600;
			color: #2ecc71;
			margin: 10px 0;
		}
		
		.editor-section {
			display: none;
		}
		
		.editor-item {
			background: #f8f9fa;
			border-radius: 6px;
			padding: 15px;
			margin-bottom: 10px;
		}
		
		.editor-item h3 {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 10px;
			font-size: 0.9rem;
		}
		
		.icon {
			width: 25px;
			height: 25px;
			border-radius: 50%;
			text-align: center;
			line-height: 25px;
			color: white;
		}
		
		.name-icon {
			background: linear-gradient(135deg, #9b59b6, #8e44ad);
		}
		
		.coins-icon {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
		}
		
		.gems-icon {
			background: linear-gradient(135deg, #3498db, #2980b9);
		}
		
		.candy-icon {
			background: linear-gradient(135deg, #e74c3c, #c0392b);
		}
		
		.current-value {
			font-size: 1.2rem;
			font-weight: bold;
			color: #2ecc71;
			text-align: center;
			margin: 5px 0;
		}
		
		.name-value {
			font-size: 1.1rem;
			font-weight: bold;
			color: #9b59b6;
			text-align: center;
			margin: 5px 0;
		}
		
		.original-value {
			font-size: 0.8rem;
			color: #666;
			text-align: center;
		}
		
		.value-input {
			width: 100%;
			padding: 8px;
			border: 2px solid #ddd;
			border-radius: 6px;
			text-align: center;
			font-weight: bold;
		}
		
		.buttons {
			display: flex;
			gap: 10px;
			margin-top: 10px;
		}
		
		.buttons button {
			flex: 1;
		}
		
		button {
			padding: 12px;
			border: none;
			border-radius: 6px;
			font-weight: 600;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 5px;
		}
		
		.btn-primary {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: white;
		}
		
		.btn-secondary {
			background: #e0e0e0;
			color: #666;
		}
		
		.error {
			background: #ffeaea;
			color: #c0392b;
			padding: 10px;
			border-radius: 6px;
			margin-top: 10px;
			display: none;
		}
		
		.success {
			background: #e8f5e8;
			color: #27ae60;
			padding: 10px;
			border-radius: 6px;
			margin-top: 10px;
			display: none;
		}
		
		.loading {
			text-align: center;
			padding: 10px;
			color: #4a6491;
			display: none;
		}
		
		footer {
			text-align: center;
			padding: 15px;
			color: #666;
			font-size: 0.8rem;
		}
		
		.tips {
			font-size: 0.8rem;
			color: #666;
			margin-top: 10px;
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>ğŸŒ± PVZ2 å­˜æ¡£ç¼–è¾‘å™¨</h1>
			<p class="subtitle">ä¿®æ”¹ç©å®¶åç§°ã€é‡‘å¸ã€é’»çŸ³ã€ç³–æœæ•°é‡</p>
		</header>
		
		<div class="content">
			<div class="file-upload-area" onclick="document.getElementById('datFile').click()">
				ğŸ“
				<p>ç‚¹å‡»é€‰æ‹©PP.datæ–‡ä»¶</p>
				<p id="fileName">æœªé€‰æ‹©æ–‡ä»¶</p>
			</div>
			<input type="file" id="datFile" accept=".dat">
			
			<div class="loading" id="loadingArea">å¤„ç†ä¸­...</div>
			
			<div id="fileError" class="error"></div>
			<div id="fileSuccess" class="success"></div>
			
			<div class="editor-section" id="editorSection">
				<div class="editor-item">
					<h3><span class="icon name-icon">ğŸ‘¤</span>ç©å®¶åç§° (n)</h3>
					<div class="original-value" id="originalName">åŸå§‹: æ— </div>
					<div class="name-value" id="currentName">æ— </div>
					<input type="text" class="value-input" id="nameInput" value="" placeholder="è¾“å…¥æ–°åç§°" maxlength="20">
				</div>
				
				<div class="editor-item">
					<h3><span class="icon coins-icon">ğŸ’°</span>é‡‘å¸ (c)</h3>
					<div class="original-value" id="originalCoins">åŸå§‹: 0</div>
					<div class="current-value" id="currentCoins">0</div>
					<input type="number" class="value-input" id="coinsInput" value="0" min="0" max="999999999">
				</div>
				
				<div class="editor-item">
					<h3><span class="icon gems-icon">ğŸ’</span>é’»çŸ³ (g)</h3>
					<div class="original-value" id="originalGems">åŸå§‹: 0</div>
					<div class="current-value" id="currentGems">0</div>
					<input type="number" class="value-input" id="gemsInput" value="0" min="0" max="999999">
				</div>
				
				<div class="editor-item">
					<h3><span class="icon candy-icon">ğŸ¬</span>è”èµ›ç³–æœ (m)</h3>
					<div class="original-value" id="originalCandy">åŸå§‹: 0</div>
					<div class="current-value" id="currentCandy">0</div>
					<input type="number" class="value-input" id="candyInput" value="0" min="0" max="999999">
				</div>
				
				<div class="buttons">
					<button class="btn-primary" onclick="saveChanges()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
					<button class="btn-secondary" onclick="resetEditor()">ğŸ”„ é‡ç½®</button>
				</div>
				
				<div id="editorError" class="error"></div>
				<div id="editorSuccess" class="success"></div>
				
				<div class="tips">
					æ³¨æ„ï¼šè¯·åŠ¡å¿…å¤‡ä»½åŸæ–‡ä»¶ï¼ä¿®æ”¹åéœ€é‡å¯æ¸¸æˆç”Ÿæ•ˆã€‚
				</div>
			</div>
		</div>
		
		<footer>
			æ•°æ®åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
		</footer>
	</div>

	<script src="json2rton.js"></script>
	<script src="rton2json.js"></script>
	
	<script>
		let originalJson = '';
		let originalJsonData = null;
		let originalHexData = '';
		
		// é€‰æ‹©æ–‡ä»¶
		document.getElementById('datFile').addEventListener('change', async function(e) {
			const file = e.target.files[0];
			if (!file) return;
			
			document.getElementById('fileName').textContent = file.name;
			showLoading();
			hideMessages();
			
			try {
				const buffer = await readFileAsArrayBuffer(file);
				originalHexData = arrayBufferToHexString(buffer);
				
				// è½¬æ¢RTONä¸ºJSON
				const rton2json = new RTON2JSON();
				rton2json.set(new Uint8Array(buffer));
				originalJson = rton2json.get();
				originalJsonData = JSON.parse(originalJson);
				
				// æŸ¥æ‰¾å„ä¸ªé”®çš„å€¼
				const playerName = findNameValue(originalJson);
				const coins = findValue(originalJson, '"c"');
				const gems = findValue(originalJson, '"g"');
				const candy = findValue(originalJson, '"m"');
				
				// æ˜¾ç¤ºå€¼
				updateDisplay('Name', playerName);
				updateDisplay('Coins', coins);
				updateDisplay('Gems', gems);
				updateDisplay('Candy', candy);
				
				// æ˜¾ç¤ºç¼–è¾‘å™¨
				document.getElementById('editorSection').style.display = 'block';
				showSuccess('fileSuccess', 'âœ… æ–‡ä»¶åŠ è½½æˆåŠŸï¼å¯ä»¥å¼€å§‹ä¿®æ”¹');
				
			} catch (error) {
				console.error('åŠ è½½å¤±è´¥:', error);
				showError('fileError', 'âŒ åŠ è½½å¤±è´¥: ' + error.message);
			} finally {
				hideLoading();
			}
		});
		
		// æŸ¥æ‰¾ç©å®¶åç§° (n)
		function findNameValue(jsonStr) {
			// æŸ¥æ‰¾ "n" é”®
			const nameIndex = jsonStr.indexOf('"n"');
			if (nameIndex === -1) {
				return 'æœªæ‰¾åˆ°åç§°';
			}
			
			// æŸ¥æ‰¾å†’å·åçš„å­—ç¬¦ä¸²
			let start = nameIndex + 3; // "n" çš„é•¿åº¦
			while (start < jsonStr.length && jsonStr[start] !== ':') start++;
			start++; // è·³è¿‡å†’å·
			
			// è·³è¿‡ç©ºæ ¼
			while (start < jsonStr.length && (jsonStr[start] <= ' ' || jsonStr[start] === ':')) start++;
			
			// æ£€æŸ¥æ˜¯å¦æ˜¯å­—ç¬¦ä¸²
			if (jsonStr[start] !== '"') {
				return 'æ— åç§°';
			}
			
			start++; // è·³è¿‡å¼€å¤´çš„å¼•å·
			
			// æŸ¥æ‰¾å­—ç¬¦ä¸²ç»“æŸä½ç½®
			let end = start;
			while (end < jsonStr.length && jsonStr[end] !== '"') end++;
			
			const nameStr = jsonStr.substring(start, end);
			return nameStr || 'æ— åç§°';
		}
		
		// æŸ¥æ‰¾JSONå­—ç¬¦ä¸²ä¸­çš„æ•°å­—å€¼
		function findValue(jsonStr, key) {
			const index = jsonStr.indexOf(key);
			if (index === -1) return 0;
			
			// æŸ¥æ‰¾å†’å·åçš„æ•°å­—
			let start = index + key.length;
			while (start < jsonStr.length && jsonStr[start] !== ':') start++;
			start++; // è·³è¿‡å†’å·
			
			// è·³è¿‡ç©ºæ ¼
			while (start < jsonStr.length && (jsonStr[start] <= ' ' || jsonStr[start] === ':')) start++;
			
			// æå–æ•°å­—
			let end = start;
			while (end < jsonStr.length && jsonStr[end] >= '0' && jsonStr[end] <= '9') end++;
			
			const numStr = jsonStr.substring(start, end);
			return parseInt(numStr) || 0;
		}
		
		// æ›¿æ¢JSONå­—ç¬¦ä¸²ä¸­çš„å€¼
		function replaceValue(jsonStr, key, newValue, isString = false) {
			let jsonCopy = jsonStr;
			let index = jsonCopy.indexOf(key);
			
			while (index !== -1) {
				// æŸ¥æ‰¾å†’å·ä½ç½®
				let colonIndex = index + key.length;
				while (colonIndex < jsonCopy.length && jsonCopy[colonIndex] !== ':') colonIndex++;
				
				// æŸ¥æ‰¾å€¼å¼€å§‹ä½ç½®
				let valStart = colonIndex + 1;
				while (valStart < jsonCopy.length && (jsonCopy[valStart] <= ' ' || jsonCopy[valStart] === ':')) valStart++;
				
				if (isString) {
					// å¤„ç†å­—ç¬¦ä¸²å€¼
					if (jsonCopy[valStart] === '"') {
						// æŸ¥æ‰¾å­—ç¬¦ä¸²ç»“æŸä½ç½®
						let valEnd = valStart + 1;
						while (valEnd < jsonCopy.length && !(jsonCopy[valEnd] === '"' && jsonCopy[valEnd-1] !== '\\')) {
							valEnd++;
						}
						valEnd++; // åŒ…å«ç»“æŸå¼•å·
						
						// æ›¿æ¢å­—ç¬¦ä¸²
						const before = jsonCopy.substring(0, valStart);
						const after = jsonCopy.substring(valEnd);
						jsonCopy = before + '"' + newValue + '"' + after;
					} else {
						// å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªé€—å·æˆ–å¤§æ‹¬å·
						let valEnd = valStart;
						while (valEnd < jsonCopy.length && jsonCopy[valEnd] !== ',' && jsonCopy[valEnd] !== '}') {
							valEnd++;
						}
						
						// æ›¿æ¢å€¼
						const before = jsonCopy.substring(0, valStart);
						const after = jsonCopy.substring(valEnd);
						jsonCopy = before + '"' + newValue + '"' + after;
					}
				} else {
					// å¤„ç†æ•°å­—å€¼
					let valEnd = valStart;
					while (valEnd < jsonCopy.length && jsonCopy[valEnd] >= '0' && jsonCopy[valEnd] <= '9') valEnd++;
					
					// æ›¿æ¢æ•°å­—
					const before = jsonCopy.substring(0, valStart);
					const after = jsonCopy.substring(valEnd);
					jsonCopy = before + newValue + after;
				}
				
				// æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
				index = jsonCopy.indexOf(key, index + 1);
			}
			
			return jsonCopy;
		}
		
		// ä¿å­˜ä¿®æ”¹
		async function saveChanges() {
			if (!originalJson) {
				showError('editorError', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
				return;
			}
			
			showLoading();
			hideMessages();
			
			try {
				const newName = document.getElementById('nameInput').value;
				const newCoins = document.getElementById('coinsInput').value;
				const newGems = document.getElementById('gemsInput').value;
				const newCandy = document.getElementById('candyInput').value;
				
				// åˆ›å»ºä¿®æ”¹åçš„JSON
				let modifiedJson = originalJson;
				
				// æ›¿æ¢æ‰€æœ‰å€¼
				if (newName.trim() !== '') {
					modifiedJson = replaceValue(modifiedJson, '"n"', newName, true);
				}
				modifiedJson = replaceValue(modifiedJson, '"c"', newCoins, false);
				modifiedJson = replaceValue(modifiedJson, '"g"', newGems, false);
				modifiedJson = replaceValue(modifiedJson, '"m"', newCandy, false);
				
				// éªŒè¯JSON
				try {
					JSON.parse(modifiedJson);
				} catch (e) {
					throw new Error('ä¿®æ”¹åçš„JSONæ ¼å¼é”™è¯¯: ' + e.message);
				}
				
				// è½¬æ¢å›RTON
				const json2rton = new JSON2RTON();
				json2rton.set(modifiedJson);
				
				let rtonData;
				try {
					// é¦–å…ˆå°è¯•è·å–ArrayBuffer
					const data = json2rton.get();
					if (data instanceof ArrayBuffer || data.buffer instanceof ArrayBuffer) {
						rtonData = new Uint8Array(data);
					} else if (typeof data === 'string') {
						// å¦‚æœæ˜¯åå…­è¿›åˆ¶å­—ç¬¦ä¸²
						const hexData = data.replace(/\s/g, '');
						rtonData = hexToArrayBuffer(hexData);
					} else {
						throw new Error('æ— æ³•è¯†åˆ«çš„æ•°æ®æ ¼å¼');
					}
				} catch (e) {
					// å°è¯•å…¶ä»–æ–¹æ³•
					try {
						const hexData = json2rton.get("hex").replace(/\s/g, '');
						rtonData = hexToArrayBuffer(hexData);
					} catch (e2) {
						throw new Error('RTONè½¬æ¢å¤±è´¥: ' + e2.message);
					}
				}
				
				// ä½¿ç”¨ä¿®å¤çš„ä¸‹è½½å‡½æ•°
				const success = await downloadFileFixed(rtonData, 'PP.dat');
				
				if (success) {
					// æ›´æ–°æ˜¾ç¤º
					updateDisplay('Name', newName, true);
					updateDisplay('Coins', newCoins, true);
					updateDisplay('Gems', newGems, true);
					updateDisplay('Candy', newCandy, true);
					
					// æ›´æ–°åŸå§‹æ•°æ®
					originalJson = modifiedJson;
					originalJsonData = JSON.parse(modifiedJson);
					
					showSuccess('editorSuccess', 'âœ… ä¿å­˜æˆåŠŸï¼æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½');
				} else {
					throw new Error('ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–æ‰‹åŠ¨ä¿å­˜');
				}
				
			} catch (error) {
				console.error('ä¿å­˜å¤±è´¥:', error);
				showError('editorError', 'âŒ ä¿å­˜å¤±è´¥: ' + error.message);
			} finally {
				hideLoading();
			}
		}
		
		// ä¿®å¤çš„ä¸‹è½½å‡½æ•° - è§£å†³æ¨¡æ‹ŸURLé—®é¢˜
		async function downloadFileFixed(data, filename) {
			return new Promise((resolve) => {
				try {
					// ç¡®ä¿æ•°æ®æ˜¯Uint8Array
					let uint8Data;
					if (data instanceof Uint8Array) {
						uint8Data = data;
					} else if (data instanceof ArrayBuffer) {
						uint8Data = new Uint8Array(data);
					} else {
						uint8Data = new Uint8Array(data);
					}
					
					// åˆ›å»ºBlob - ä½¿ç”¨æ­£ç¡®çš„MIMEç±»å‹
					const blob = new Blob([uint8Data], { 
						type: 'application/octet-stream' 
					});
					
					// åˆ›å»ºå¯¹è±¡URL
					const url = URL.createObjectURL(blob);
					
					// åˆ›å»ºä¸‹è½½é“¾æ¥
					const a = document.createElement('a');
					a.href = url;
					a.download = filename || 'PP.dat';
					
					// æ·»åŠ å¿…è¦çš„å±æ€§
					a.style.display = 'none';
					a.setAttribute('download', filename);
					
					// æ·»åŠ åˆ°DOMï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
					document.body.appendChild(a);
					
					// è§¦å‘ç‚¹å‡»
					a.click();
					
					// å»¶è¿Ÿæ¸…ç†
					setTimeout(() => {
						document.body.removeChild(a);
						URL.revokeObjectURL(url);
						resolve(true);
					}, 1000);
					
				} catch (error) {
					console.error('ä¸‹è½½é”™è¯¯:', error);
					
					// å¤‡ç”¨æ–¹æ¡ˆï¼šé€šè¿‡iframeä¸‹è½½
					try {
						const blob = new Blob([data], { 
							type: 'application/octet-stream' 
						});
						const url = URL.createObjectURL(blob);
						
						const iframe = document.createElement('iframe');
						iframe.style.display = 'none';
						iframe.src = url;
						document.body.appendChild(iframe);
						
						setTimeout(() => {
							document.body.removeChild(iframe);
							URL.revokeObjectURL(url);
							resolve(true);
						}, 1000);
					} catch (iframeError) {
						console.error('iframeä¸‹è½½å¤±è´¥:', iframeError);
						resolve(false);
					}
				}
			});
		}
		
		// é‡ç½®ä¿®æ”¹
		function resetEditor() {
			if (originalJsonData) {
				const playerName = findNameValue(originalJson);
				const coins = findValue(originalJson, '"c"');
				const gems = findValue(originalJson, '"g"');
				const candy = findValue(originalJson, '"m"');
				
				document.getElementById('nameInput').value = playerName;
				document.getElementById('coinsInput').value = coins;
				document.getElementById('gemsInput').value = gems;
				document.getElementById('candyInput').value = candy;
				
				document.getElementById('currentName').textContent = playerName;
				document.getElementById('currentCoins').textContent = coins;
				document.getElementById('currentGems').textContent = gems;
				document.getElementById('currentCandy').textContent = candy;
				
				showSuccess('editorSuccess', 'ğŸ”„ å·²é‡ç½®ä¸ºåŸå§‹å€¼');
			}
		}
		
		// æ›´æ–°æ˜¾ç¤º
		function updateDisplay(type, value, updateOriginal = false) {
			const typeLower = type.toLowerCase();
			const currentEl = document.getElementById(`current${type}`);
			const inputEl = document.getElementById(`${typeLower}Input`);
			
			if (currentEl) currentEl.textContent = value;
			if (inputEl) inputEl.value = value;
			
			if (updateOriginal) {
				const originalEl = document.getElementById(`original${type}`);
				if (originalEl) originalEl.textContent = 'åŸå§‹: ' + value;
			} else {
				const originalEl = document.getElementById(`original${type}`);
				if (originalEl) originalEl.textContent = 'åŸå§‹: ' + value;
			}
		}
		
		// å·¥å…·å‡½æ•°
		function readFileAsArrayBuffer(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result);
				reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥: ' + e.target.error));
				reader.readAsArrayBuffer(file);
			});
		}
		
		function arrayBufferToHexString(buffer) {
			const bytes = new Uint8Array(buffer);
			let hex = '';
			for (let i = 0; i < bytes.length; i++) {
				const byte = bytes[i].toString(16).padStart(2, '0');
				hex += byte;
			}
			return hex;
		}
		
		function hexToArrayBuffer(hex) {
			hex = hex.replace(/\s/g, '');
			if (hex.length % 2 !== 0) {
				hex = '0' + hex;
			}
			const bytes = new Uint8Array(hex.length / 2);
			for (let i = 0; i < hex.length; i += 2) {
				bytes[i/2] = parseInt(hex.substr(i, 2), 16);
			}
			return bytes;
		}
		
		function showError(id, msg) {
			const el = document.getElementById(id);
			if (el) {
				el.textContent = msg;
				el.style.display = 'block';
				setTimeout(() => el.style.display = 'none', 5000);
			}
		}
		
		function showSuccess(id, msg) {
			const el = document.getElementById(id);
			if (el) {
				el.textContent = msg;
				el.style.display = 'block';
				setTimeout(() => el.style.display = 'none', 5000);
			}
		}
		
		function hideMessages() {
			['fileError', 'fileSuccess', 'editorError', 'editorSuccess'].forEach(id => {
				const el = document.getElementById(id);
				if (el) el.style.display = 'none';
			});
		}
		
		function showLoading() {
			document.getElementById('loadingArea').style.display = 'block';
		}
		
		function hideLoading() {
			document.getElementById('loadingArea').style.display = 'none';
		}
	</script>
</body>
</html>